/* @flow */

import bluebird      from 'bluebird'
import promisePlugin from 'superagent-promise-plugin'
import request       from 'superagent'
import objectAssign  from 'object-assign'

promisePlugin.Promise = bluebird

import type { Realm } from './types'

/**
 * @class user
 * @singleton
 *
 * Module that exports {@link User}.  Import with:
 *
 *     var Realm = require('tozny-auth/lib/user');
 *
 * or
 *
 *     var Realm = require('tozny-auth').User;
 *
 */

/**
 * @property {User} exports
 */

/**
 * @class User
 * Provides methods for making API calls to Tozny on behalf of a user.
 *
 * @constructor
 * @param {string} realmKeyId
 * @param {string} [inApiUrl=process.env.API_URL] URL of Tozny service
 */
export default function User(realmKeyId: string, inApiUrl?: ?string) {
  if (!(this instanceof User)) {
    return new User(realmKeyId, inApiUrl);
  }

  const processApiUrl = typeof process !== 'undefined' && process.env
    ? process.env.API_URL
    : undefined
  const apiUrl = inApiUrl || processApiUrl || 'https://api.tozny.com'

  /**
   * Used to make custom API calls.
   *
   * @param {string} method Name of method to invoke via RPC.
   * @param {Object} [params] Parameters to send.
   * @return {Promise.<Object>} Result depends on the API call that is made
   */
  function rawCall(method, params) {
    var req = {
      method: method
    };
    if (params) {
      objectAssign(req, params);
    }
    return request.get(apiUrl).query(req).use(promisePlugin).then(resp => resp.body);
  }


  /**
   * Produces a login challenge, which can be transmitted to a Tozny-enabled
   * application to complete authentication.
   *
   * @return {Promise.<{ signed_data: string, signature: string }>}
   */
  function loginChallenge() {
    return rawCall('user.login_challenge', { realm_key_id: realmKeyId });
  }

  /**
   * Fetches realm metadata
   *
   * @return {Promise.<Object>}
   */
  function realmGet(): Promise<Realm> {
    return rawCall('user.realm_get')
  }

  objectAssign(this, {
    loginChallenge: loginChallenge,
    realmGet:       realmGet,
    rawCall:        rawCall,
  });

  Object.freeze(this);
}
